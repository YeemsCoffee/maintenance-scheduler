<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Scheduler</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üîß Maintenance Scheduler</h1>
                <div class="header-actions">
                    <span class="user-info">
                        üë§ <span id="currentUser"></span> (<span id="currentRole"></span>)
                    </span>
                    <div class="notification-bell" onclick="toggleNotifications()">
                        üîî
                        <span id="notificationBadge" class="notification-badge">0</span>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="showPage('workload')" id="workloadBtn">üë• Workload</button>
                    <button class="btn btn-secondary btn-small" onclick="showPage('calendar')">üìÖ Calendar</button>
                    <button class="btn btn-secondary btn-small hidden" onclick="showPage('users')" id="manageUsersBtn">Manage Users</button>
                    <button class="btn btn-secondary btn-small" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Notification Panel -->
        <div id="notificationPanel" class="notification-panel">
            <div class="notification-header">
                <h3 class="notification-header-title">Notifications</h3>
                <button class="btn btn-secondary btn-small" onclick="markAllRead()">Mark all read</button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="notification-empty">
                    No notifications
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <!-- Stats Grid -->
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalTasks">0</div>
                    <div class="stat-label">My Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statOverdue">0</div>
                    <div class="stat-label">Overdue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDueWeek">0</div>
                    <div class="stat-label">Due This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-label">Completed This Month</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h2>üóÇÔ∏è Functional Location Structure</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddLocationModal()">+ Add Location</button>
                    </div>
                    <div class="tree" id="flocTreeNav">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Location Details & Tasks</h2>
                    <div id="flocTaskView">
                        <div class="empty-state">Select a functional location from the tree</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workload Page -->
        <div id="workload" class="page">
            <div class="card">
                <div class="card-header">
                    <h2>üë• Team Workload</h2>
                    <button class="btn btn-secondary btn-small" onclick="showPage('dashboard')">‚Üê Back</button>
                </div>
                <table class="workload-table">
                    <thead>
                        <tr>
                            <th>Technician</th>
                            <th>Total Tasks</th>
                            <th>Overdue</th>
                            <th>Due This Week</th>
                            <th>Workload</th>
                        </tr>
                    </thead>
                    <tbody id="workloadTableBody">
                        <tr>
                            <td colspan="5" class="empty-state">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendar" class="page">
            <div class="card">
                <div class="card-header">
                    <h2>üìÖ Maintenance Calendar</h2>
                    <div class="calendar-controls">
                        <button class="btn btn-secondary btn-small" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <span id="calendarMonth" class="calendar-month-display"></span>
                        <button class="btn btn-secondary btn-small" onclick="changeMonth(1)">Next ‚Üí</button>
                        <button class="btn btn-secondary btn-small" onclick="showPage('dashboard')">‚Üê Back</button>
                    </div>
                </div>
                <div id="calendarView"></div>
            </div>
        </div>

        <!-- Tasks Management Page -->
        <div id="tasks" class="page">
            <div class="card">
                <h2>‚úèÔ∏è Edit Task</h2>
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="taskName" placeholder="e.g., Oil change">
                </div>
                <div class="two-col-grid">
                    <div class="form-group">
                        <label>Frequency (days)</label>
                        <input type="number" id="taskFreq" placeholder="90">
                    </div>
                    <div class="form-group">
                        <label>Next Run Date</label>
                        <input type="date" id="taskDate">
                    </div>
                </div>
                <div class="two-col-grid">
                    <div class="form-group">
                        <label>Location</label>
                        <select id="taskLocation">
                            <option value="">Select location...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Functional Location</label>
                        <select id="taskFuncLoc">
                            <option value="">Select functional location...</option>
                        </select>
                    </div>
                </div>
                <div class="two-col-grid">
                    <div class="form-group">
                        <label>Assign To</label>
                        <select id="taskAssignee">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="taskStatus">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Part Name</label>
                    <input type="text" id="taskPart" placeholder="Optional">
                </div>
                <div class="two-col-grid">
                    <div class="form-group">
                        <label>Lead Time (days)</label>
                        <input type="number" id="taskLead" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" id="taskVendor" placeholder="Optional">
                    </div>
                </div>
                <div class="form-group">
                    <label>Vendor Part Number</label>
                    <input type="text" id="taskVendorPN" placeholder="Optional">
                </div>
                
                <div class="form-group">
                    <label>üìé Attachments (SOPs, Job Aids, etc.)</label>
                    <div id="attachmentsList" class="attachments-list"></div>
                    <div class="file-upload-group">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.xlsx,.xls" class="file-input">
                        <button class="btn btn-secondary btn-small" onclick="uploadFile()">Upload</button>
                    </div>
                </div>

                <!-- Completion History -->
                <div class="form-group">
                    <label>üìú Completion History</label>
                    <div id="completionHistory">
                        <p class="empty-state-text">No completions yet</p>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="completeTaskPrompt()" id="completeTaskBtn">‚úì Complete Task</button>
                    <button class="btn btn-primary" id="updateTaskBtn" onclick="updateTask()">Save Changes</button>
                    <button class="btn btn-danger" id="deleteTaskBtn" onclick="deleteTask()">Delete Task</button>
                    <button class="btn btn-secondary" onclick="showPage('dashboard')">‚Üê Back</button>
                </div>
            </div>
        </div>

        <!-- Complete Task Modal -->
        <div id="completeTaskModal" class="complete-task-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úì Complete Task</h2>
                    <p id="completeTaskName" class="modal-subtitle"></p>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Completion Status</label>
                        <select id="completionStatus">
                            <option value="completed">‚úì Completed Successfully</option>
                            <option value="skipped">‚äò Skipped (with reason)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes / Observations</label>
                        <textarea id="completionNotes" placeholder="Any notes about the work performed..."></textarea>
                    </div>
                    <div class="two-col-grid">
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="completionDuration" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label>Labor Hours</label>
                            <input type="number" step="0.5" id="completionLabor" placeholder="1.0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Parts Used</label>
                        <textarea id="completionParts" placeholder="List parts used (optional)..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="submitCompletion()">Complete Task</button>
                        <button class="btn btn-secondary" onclick="closeCompleteModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Functional Locations Management Page -->
        <div id="funcloc" class="page">
            <div class="grid">
                <div class="card">
                    <h2>üóÇÔ∏è Functional Location Structure</h2>
                    <div class="tree" id="flocTree">
                        <div class="empty-state">Loading...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="refreshFlocs()">Refresh</button>
                        <button class="btn btn-secondary btn-auto-margin" onclick="showPage('dashboard')">‚Üê Back</button>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h2>‚úèÔ∏è Edit Selected</h2>
                        <div id="flocEditSection">
                            <p class="empty-state-text">Select a functional location from the tree</p>
                        </div>
                    </div>

                    <div class="card">
                        <h2>‚ûï Add New Location</h2>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="newFlocName" placeholder="e.g., Building A">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="newFlocDesc" placeholder="Optional description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Parent Location (optional)</label>
                            <select id="newFlocParent">
                                <option value="">(None)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addFloc()">Add Location</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Page -->
        <div id="users" class="page">
            <div class="card">
                <h2>üë• User Management</h2>
                <table class="workload-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Notifications</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="empty-state">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="refreshUsers()">Refresh</button>
                    <button class="btn btn-secondary btn-auto-margin" onclick="showPage('dashboard')">‚Üê Back</button>
                </div>
            </div>
        </div>

        <!-- Add Location Modal -->
        <div id="addLocationModal" class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>‚ûï Create Functional Location</h2>
                    <p>Add a new location to organize your maintenance tasks</p>
                </div>
                
                <div class="modal-body">
                    <div class="form-group">
                        <label>Location Name *</label>
                        <input type="text" id="modalFlocName" placeholder="e.g., Building A, Floor 2">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="modalFlocDesc" placeholder="Optional: Add details..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Parent Location</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="parentType" value="none" checked onclick="toggleParentSelect(false)">
                                <div class="radio-content">
                                    <div class="radio-title">üè† Top Level Location</div>
                                    <div class="radio-desc">This will be a root location</div>
                                </div>
                            </label>
                        </div>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="parentType" value="child" onclick="toggleParentSelect(true)">
                                <div class="radio-content">
                                    <div class="radio-title">üìÅ Sub-Location</div>
                                    <div class="radio-desc">Place under an existing location</div>
                                </div>
                            </label>
                        </div>
                        <div id="parentSelectContainer" class="parent-select-container">
                            <select id="modalFlocParent" class="parent-select">
                                <option value="">Choose parent...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addLocationFromModal()">‚úì Create</button>
                        <button class="btn btn-secondary" onclick="closeAddLocationModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentTasks = [];
        let currentFlocs = [];
        let currentLocations = [];
        let currentUsers = [];
        let selectedTaskId = null;
        let selectedFlocId = null;
        let expandedTreeNodes = new Set();
        let currentAttachments = [];
        let currentUserData = null;
        let currentCalendarDate = new Date();
        let notificationPanelOpen = false;

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = `${API_BASE}/login.html`;
                    return false;
                }
                currentUserData = await response.json();
                document.getElementById('currentUser').textContent = currentUserData.username;
                document.getElementById('currentRole').textContent = currentUserData.role;
                
                if (currentUserData.role === 'admin') {
                    document.getElementById('manageUsersBtn').classList.remove('hidden');
                }
                
                updateNotificationBadge();
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = `${API_BASE}/login.html`;
                return false;
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = `${API_BASE}/login.html`;
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = `${API_BASE}/login.html`;
            }
        }

        // Notification functions
        async function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (currentUserData.unread_notifications > 0) {
                badge.textContent = currentUserData.unread_notifications;
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/api/notifications`, {
                    credentials: 'include'
                });
                const notifications = await response.json();
                
                const listDiv = document.getElementById('notificationList');
                if (notifications.length === 0) {
                    listDiv.innerHTML = '<div class="notification-empty">No notifications</div>';
                    return;
                }
                
                listDiv.innerHTML = notifications.map(n => `
                    <div class="notification-item ${!n.is_read ? 'unread' : ''}" onclick="handleNotificationClick(${n.id}, ${n.task_id})">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${formatRelativeTime(n.created_at)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function handleNotificationClick(notifId, taskId) {
            // Mark as read
            await fetch(`${API_BASE}/api/notifications/${notifId}/read`, {
                method: 'PUT',
                credentials: 'include'
            });
            
            // Refresh auth to update badge
            await checkAuth();
            
            // Close panel
            toggleNotifications();
            
            // Navigate to task if applicable
            if (taskId) {
                const task = currentTasks.find(t => t.id === taskId);
                if (task) {
                    editTaskFromDashboard(taskId);
                }
            }
        }

        async function markAllRead() {
            await fetch(`${API_BASE}/api/notifications/mark-all-read`, {
                method: 'PUT',
                credentials: 'include'
            });
            await checkAuth();
            await loadNotifications();
        }

        function toggleNotifications() {
            notificationPanelOpen = !notificationPanelOpen;
            const panel = document.getElementById('notificationPanel');
            if (notificationPanelOpen) {
                panel.classList.add('active');
                loadNotifications();
            } else {
                panel.classList.remove('active');
            }
        }

        function formatRelativeTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'funcloc') {
                refreshFlocs();
            } else if (pageId === 'dashboard') {
                loadDashboard();
            } else if (pageId === 'users') {
                refreshUsers();
            } else if (pageId === 'calendar') {
                renderCalendar();
            } else if (pageId === 'workload') {
                loadWorkload();
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const [tasks, locations, flocs, users, stats] = await Promise.all([
                    fetch(`${API_BASE}/tasks`, {credentials: 'include'}).then(r => r.json()),
                    fetch(`${API_BASE}/locations`, {credentials: 'include'}).then(r => r.json()),
                    fetch(`${API_BASE}/funclocations`, {credentials: 'include'}).then(r => r.json()),
                    fetch(`${API_BASE}/api/users`, {credentials: 'include'}).then(r => r.json()),
                    fetch(`${API_BASE}/api/dashboard/stats`, {credentials: 'include'}).then(r => r.json())
                ]);

                currentTasks = tasks;
                currentFlocs = flocs;
                currentLocations = locations;
                currentUsers = users;

                // Update stats
                document.getElementById('statTotalTasks').textContent = stats.my_tasks.total;
                document.getElementById('statOverdue').textContent = stats.my_tasks.overdue;
                document.getElementById('statDueWeek').textContent = stats.my_tasks.due_this_week;
                document.getElementById('statCompleted').textContent = stats.my_tasks.completed_this_month;

                buildFlocTreeNav();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadWorkload() {
            try {
                const response = await fetch(`${API_BASE}/api/workload`, {credentials: 'include'});
                const workload = await response.json();
                
                const tbody = document.getElementById('workloadTableBody');
                if (workload.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = workload.map(w => {
                    const workloadPercent = Math.min((w.total_tasks / 20) * 100, 100);
                    const isHigh = w.total_tasks > 15;
                    
                    return `
                        <tr>
                            <td>
                                <strong>${w.username}</strong><br>
                                <span class="user-email">${w.email}</span>
                            </td>
                            <td><strong>${w.total_tasks}</strong></td>
                            <td><span class="overdue-count">${w.overdue}</span></td>
                            <td><span class="due-soon-count">${w.due_this_week}</span></td>
                            <td>
                                <div class="workload-bar">
                                    <div class="workload-bar-fill ${isHigh ? 'high' : ''}" data-width="${workloadPercent}"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Apply widths after HTML is inserted
                setTimeout(() => {
                    document.querySelectorAll('.workload-bar-fill').forEach(el => {
                        el.style.width = el.getAttribute('data-width') + '%';
                    });
                }, 0);
            } catch (error) {
                console.error('Error loading workload:', error);
            }
        }

        function buildFlocTreeNav() {
            const treeDiv = document.getElementById('flocTreeNav');
            
            if (currentFlocs.length === 0) {
                treeDiv.innerHTML = '<div class="empty-state">No functional locations yet.</div>';
                return;
            }

            const byId = {};
            currentFlocs.forEach(f => byId[f.id] = { ...f, children: [] });

            const roots = [];
            Object.values(byId).forEach(f => {
                if (f.parent_id && byId[f.parent_id]) {
                    byId[f.parent_id].children.push(f);
                } else {
                    roots.push(f);
                }
            });

            function getDescendantTaskCount(flocId) {
                let count = currentTasks.filter(t => t.func_loc_id === flocId).length;
                const children = currentFlocs.filter(f => f.parent_id === flocId);
                children.forEach(child => {
                    count += getDescendantTaskCount(child.id);
                });
                return count;
            }

            function renderNode(node, level = 0) {
                const indent = level > 0 ? 'tree-node-child' : '';
                const totalTasks = getDescendantTaskCount(node.id);
                const hasChildren = node.children.length > 0;
                const isExpanded = expandedTreeNodes.has(node.id);
                
                let html = `
                    <div class="${indent} tree-node" data-id="${node.id}">
                        ${hasChildren ? `<span onclick="toggleTreeNode(${node.id}); event.stopPropagation();" class="tree-toggle">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : '<span class="tree-spacer"></span>'}
                        <span onclick="selectFlocFromTree(${node.id})">${node.name} <span class="tree-task-count">(${totalTasks})</span></span>
                    </div>`;
                
                if (hasChildren && isExpanded) {
                    node.children.sort((a, b) => a.name.localeCompare(b.name)).forEach(child => {
                        html += renderNode(child, level + 1);
                    });
                }
                return html;
            }

            treeDiv.innerHTML = roots.sort((a, b) => a.name.localeCompare(b.name))
                .map(r => renderNode(r)).join('');
        }

        function toggleTreeNode(flocId) {
            if (expandedTreeNodes.has(flocId)) {
                expandedTreeNodes.delete(flocId);
            } else {
                expandedTreeNodes.add(flocId);
            }
            buildFlocTreeNav();
        }

        function selectFlocFromTree(id) {
            document.querySelectorAll('#flocTreeNav .tree-node').forEach(n => {
                const nodeId = n.getAttribute('data-id');
                if (nodeId == id) {
                    n.classList.add('selected');
                } else {
                    n.classList.remove('selected');
                }
            });

            const floc = currentFlocs.find(f => f.id === id);
            if (!floc) return;

            buildFlocDetailView(floc);
        }

        function buildFlocDetailView(floc) {
            const viewDiv = document.getElementById('flocTaskView');
            
            function getAllChildren(flocId) {
                const children = [];
                currentFlocs.forEach(f => {
                    if (f.parent_id === flocId) {
                        children.push(f);
                        children.push(...getAllChildren(f.id));
                    }
                });
                return children;
            }
            
            const children = getAllChildren(floc.id);
            const descendantIds = [floc.id, ...children.map(c => c.id)];
            const allTasks = currentTasks.filter(t => descendantIds.includes(t.func_loc_id));
            const directTasks = currentTasks.filter(t => t.func_loc_id === floc.id);

            let html = `
                <div class="floc-detail-header">
                    <h3 class="floc-detail-title">${floc.name}</h3>
                    ${floc.description ? `<p class="floc-detail-desc">${floc.description}</p>` : ''}
                    <p class="floc-detail-stats">
                        Total Tasks: ${allTasks.length}
                    </p>
                </div>
            `;

            if (directTasks.length > 0) {
                html += `<h4 class="task-section-title">Direct Tasks (${directTasks.length})</h4>`;
                html += renderTaskList(directTasks);
            }

            if (allTasks.length === 0) {
                html += '<div class="no-tasks">No tasks assigned</div>';
            }

            viewDiv.innerHTML = html;
        }

        function renderTaskList(tasks) {
            return `<div class="task-list">
                ${tasks.map(t => `
                    <div class="task-item task-status-${t.status}" onclick="editTaskFromDashboard(${t.id})">
                        <div class="task-item-left">
                            <div class="task-name">
                                ${t.name}
                                <span class="status-badge status-${t.status}">${t.status.replace('_', ' ')}</span>
                            </div>
                            <div class="task-details">
                                üìç ${t.location}
                                ${t.assignee_name ? ` | üë§ ${t.assignee_name}` : ' | ‚ö†Ô∏è Unassigned'}
                                ${t.part_name ? ` | üîß ${t.part_name}` : ''}
                                ${t.completion_count > 0 ? ` | ‚úì Completed ${t.completion_count}x` : ''}
                            </div>
                        </div>
                        <div class="task-item-right">
                            <div class="task-date">${t.next_run.split('T')[0]}</div>
                            <div class="task-freq">Every ${t.frequency_days} days</div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }

        async function editTaskFromDashboard(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            selectedTaskId = task.id;
            currentAttachments = task.attachments || [];

            document.getElementById('taskName').value = task.name;
            document.getElementById('taskFreq').value = task.frequency_days;
            document.getElementById('taskDate').value = task.next_run.split('T')[0];
            document.getElementById('taskStatus').value = task.status;
            
            const locSelect = document.getElementById('taskLocation');
            locSelect.innerHTML = '<option value="">Select location...</option>' +
                currentLocations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            
            const locOpt = Array.from(locSelect.options).find(opt => opt.text === task.location);
            if (locOpt) locSelect.value = locOpt.value;

            const flocSelect = document.getElementById('taskFuncLoc');
            flocSelect.innerHTML = '<option value="">Select functional location...</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            if (task.func_loc_id) flocSelect.value = task.func_loc_id;

            const assigneeSelect = document.getElementById('taskAssignee');
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>' +
                currentUsers.filter(u => u.is_active).map(u => `<option value="${u.id}">${u.username} (${u.role})</option>`).join('');
            if (task.assigned_to) assigneeSelect.value = task.assigned_to;

            document.getElementById('taskPart').value = task.part_name || '';
            document.getElementById('taskLead').value = task.lead_time_days || '';
            document.getElementById('taskVendor').value = task.vendor || '';
            document.getElementById('taskVendorPN').value = task.vendor_part_number || '';

            displayAttachments();
            await loadCompletionHistory(taskId);

            showPage('tasks');
        }

        async function loadCompletionHistory(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/completions`, {
                    credentials: 'include'
                });
                const completions = await response.json();
                
                const historyDiv = document.getElementById('completionHistory');
                if (completions.length === 0) {
                    historyDiv.innerHTML = '<p class="empty-state-text">No completions yet</p>';
                    return;
                }
                
                historyDiv.innerHTML = completions.map(c => `
                    <div class="completion-history-item">
                        <div class="completion-header">
                            <strong>${c.status === 'completed' ? '‚úì' : '‚äò'} ${c.status}</strong>
                            <span class="completion-date">${new Date(c.completed_at).toLocaleString()}</span>
                        </div>
                        <div class="completion-detail">
                            Completed by: <strong>${c.completed_by}</strong>
                        </div>
                        ${c.duration_minutes ? `<div class="completion-detail">Duration: ${c.duration_minutes} minutes</div>` : ''}
                        ${c.labor_hours ? `<div class="completion-detail">Labor: ${c.labor_hours} hours</div>` : ''}
                        ${c.notes ? `<div class="completion-notes">"${c.notes}"</div>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading completion history:', error);
            }
        }

        function displayAttachments() {
            const listDiv = document.getElementById('attachmentsList');
            
            if (currentAttachments.length === 0) {
                listDiv.innerHTML = '<p class="empty-state-text">No attachments</p>';
                return;
            }

            const getFileIcon = (fileType) => {
                if (['pdf'].includes(fileType)) return 'üìÑ';
                if (['doc', 'docx'].includes(fileType)) return 'üìù';
                if (['xls', 'xlsx'].includes(fileType)) return 'üìä';
                if (['png', 'jpg', 'jpeg', 'gif'].includes(fileType)) return 'üñºÔ∏è';
                return 'üìé';
            };

            listDiv.innerHTML = currentAttachments.map(att => `
                <div class="attachment-item">
                    <div class="attachment-name">
                        <span class="attachment-icon">${getFileIcon(att.file_type)}</span>
                        <span>${att.original_filename}</span>
                    </div>
                    <div class="attachment-actions">
                        <button class="btn btn-icon" onclick="downloadAttachment(${att.id})">‚¨á Download</button>
                        <button class="btn btn-icon" onclick="deleteAttachment(${att.id})">üóë Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!selectedTaskId) {
                alert('No task selected');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/tasks/${selectedTaskId}/attachments`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const attachment = await response.json();
                currentAttachments.push(attachment);
                displayAttachments();
                fileInput.value = '';
                alert('File uploaded!');
            } catch (error) {
                console.error('Error uploading:', error);
                alert('Failed to upload');
            }
        }

        async function downloadAttachment(attachmentId) {
            window.open(`${API_BASE}/attachments/${attachmentId}/download`, '_blank');
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Delete this attachment?')) return;

            try {
                await fetch(`${API_BASE}/attachments/${attachmentId}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                currentAttachments = currentAttachments.filter(a => a.id !== attachmentId);
                displayAttachments();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete');
            }
        }

        function completeTaskPrompt() {
            const task = currentTasks.find(t => t.id === selectedTaskId);
            if (!task) return;
            
            document.getElementById('completeTaskName').textContent = task.name;
            document.getElementById('completeTaskModal').classList.add('active');
        }

        function closeCompleteModal() {
            document.getElementById('completeTaskModal').classList.remove('active');
            document.getElementById('completionNotes').value = '';
            document.getElementById('completionDuration').value = '';
            document.getElementById('completionLabor').value = '';
            document.getElementById('completionParts').value = '';
            document.getElementById('completionStatus').value = 'completed';
        }

        async function submitCompletion() {
            if (!selectedTaskId) return;

            const data = {
                status: document.getElementById('completionStatus').value,
                notes: document.getElementById('completionNotes').value || null,
                duration_minutes: parseInt(document.getElementById('completionDuration').value) || null,
                labor_hours: parseFloat(document.getElementById('completionLabor').value) || null,
                parts_used: document.getElementById('completionParts').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/tasks/${selectedTaskId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Completion failed');

                await loadDashboard();
                closeCompleteModal();
                alert('Task completed successfully!');
                showPage('dashboard');
            } catch (error) {
                console.error('Error completing task:', error);
                alert('Failed to complete task');
            }
        }

        async function updateTask() {
            if (!selectedTaskId) return;

            const data = {
                name: document.getElementById('taskName').value.trim(),
                frequency_days: parseInt(document.getElementById('taskFreq').value),
                next_run: document.getElementById('taskDate').value,
                location_id: parseInt(document.getElementById('taskLocation').value),
                func_loc_id: document.getElementById('taskFuncLoc').value || null,
                assigned_to: document.getElementById('taskAssignee').value || null,
                status: document.getElementById('taskStatus').value,
                part_name: document.getElementById('taskPart').value || '',
                vendor: document.getElementById('taskVendor').value || '',
                vendor_part_number: document.getElementById('taskVendorPN').value || '',
                lead_time_days: parseInt(document.getElementById('taskLead').value) || 0
            };

            if (!data.name || !data.frequency_days || !data.next_run || !data.location_id) {
                alert('Please fill required fields');
                return;
            }

            try {
                await fetch(`${API_BASE}/tasks/${selectedTaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                await loadDashboard();
                alert('Task updated!');
                showPage('dashboard');
            } catch (error) {
                console.error('Error updating:', error);
                alert('Failed to update');
            }
        }

        async function deleteTask() {
            if (!selectedTaskId || !confirm('Delete this task?')) return;

            try {
                await fetch(`${API_BASE}/tasks/${selectedTaskId}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                await loadDashboard();
                alert('Task deleted!');
                showPage('dashboard');
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete');
            }
        }

        async function refreshFlocs() {
            try {
                const flocs = await fetch(`${API_BASE}/funclocations`, {credentials: 'include'}).then(r => r.json());
                currentFlocs = flocs;
                buildFlocTree(flocs);
                updateFlocDropdowns();
            } catch (error) {
                console.error('Error refreshing:', error);
            }
        }

        function buildFlocTree(flocs) {
            const byId = {};
            flocs.forEach(f => byId[f.id] = { ...f, children: [] });

            const roots = [];
            Object.values(byId).forEach(f => {
                if (f.parent_id && byId[f.parent_id]) {
                    byId[f.parent_id].children.push(f);
                } else {
                    roots.push(f);
                }
            });

            const treeDiv = document.getElementById('flocTree');
            if (roots.length === 0) {
                treeDiv.innerHTML = '<div class="empty-state">No locations yet</div>';
                return;
            }

            function renderNode(node, level = 0) {
                const indent = level > 0 ? 'tree-node-child' : '';
                let html = `<div class="${indent} tree-node" onclick="selectFloc(${node.id})" data-id="${node.id}">${node.name}</div>`;
                node.children.sort((a, b) => a.name.localeCompare(b.name)).forEach(child => {
                    html += renderNode(child, level + 1);
                });
                return html;
            }

            treeDiv.innerHTML = roots.sort((a, b) => a.name.localeCompare(b.name))
                .map(r => renderNode(r)).join('');
        }

        function selectFloc(id) {
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            document.querySelector(`.tree-node[data-id="${id}"]`).classList.add('selected');

            selectedFlocId = id;
            const floc = currentFlocs.find(f => f.id === id);
            if (!floc) return;

            document.getElementById('flocEditSection').innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editFlocName" value="${floc.name}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editFlocDesc">${floc.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Parent Location</label>
                    <select id="editFlocParent">
                        <option value="">(None)</option>
                        ${currentFlocs.filter(f => f.id !== id).map(f => 
                            `<option value="${f.id}" ${f.id === floc.parent_id ? 'selected' : ''}>${f.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveFloc()">Save Changes</button>
                    <button class="btn btn-danger" onclick="deleteFloc()">Delete</button>
                </div>
            `;
        }

        function updateFlocDropdowns() {
            const parentSelect = document.getElementById('newFlocParent');
            parentSelect.innerHTML = '<option value="">(None)</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        }

        async function saveFloc() {
            if (!selectedFlocId) return;

            const data = {
                name: document.getElementById('editFlocName').value.trim(),
                description: document.getElementById('editFlocDesc').value || null,
                parent_id: document.getElementById('editFlocParent').value || null
            };

            if (!data.name) {
                alert('Name required');
                return;
            }

            try {
                await fetch(`${API_BASE}/funclocations/${selectedFlocId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                await refreshFlocs();
                await loadDashboard();
                alert('Saved!');
            } catch (error) {
                console.error('Error saving:', error);
                alert('Failed to save');
            }
        }

        async function deleteFloc() {
            if (!selectedFlocId || !confirm('Delete this location?')) return;

            try {
                const response = await fetch(`${API_BASE}/funclocations/${selectedFlocId}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!response.ok) {
                    const data = await response.json();
                    alert('Failed: ' + data.message);
                    return;
                }

                selectedFlocId = null;
                await refreshFlocs();
                await loadDashboard();
                document.getElementById('flocEditSection').innerHTML = '<p class="empty-state-text">Select a location</p>';
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete');
            }
        }

        async function addFloc() {
            const data = {
                name: document.getElementById('newFlocName').value.trim(),
                description: document.getElementById('newFlocDesc').value || null,
                parent_id: document.getElementById('newFlocParent').value || null
            };

            if (!data.name) {
                alert('Name required');
                return;
            }

            try {
                await fetch(`${API_BASE}/funclocations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                document.getElementById('newFlocName').value = '';
                document.getElementById('newFlocDesc').value = '';
                document.getElementById('newFlocParent').value = '';
                await refreshFlocs();
                await loadDashboard();
            } catch (error) {
                console.error('Error adding:', error);
                alert('Failed to add');
            }
        }

        async function refreshUsers() {
            if (currentUserData.role !== 'admin') {
                alert('Admin access required');
                showPage('dashboard');
                return;
            }

            try {
                const users = await fetch(`${API_BASE}/api/users`, {credentials: 'include'}).then(r => r.json());

                const tbody = document.getElementById('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users</td></tr>';
                } else {
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            <td><strong>${u.username}</strong></td>
                            <td>${u.email}</td>
                            <td>
                                <select onchange="updateUserRole(${u.id}, this.value)" ${u.username === 'admin' ? 'disabled' : ''}>
                                    <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="technician" ${u.role === 'technician' ? 'selected' : ''}>Technician</option>
                                    <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                </select>
                            </td>
                            <td>
                                <span class="user-status ${u.is_active ? 'active' : 'inactive'}">
                                    ${u.is_active ? '‚úì Active' : '‚úó Disabled'}
                                </span>
                            </td>
                            <td class="notification-prefs">
                                ${u.notify_assigned ? '‚úì Assigned' : ''} 
                                ${u.notify_due_soon ? '‚úì Due Soon' : ''} 
                                ${u.notify_overdue ? '‚úì Overdue' : ''}
                                <br><small>${u.notification_days_ahead} days ahead</small>
                            </td>
                            <td>
                                ${u.username !== 'admin' ? `
                                    <button class="btn btn-secondary btn-small" onclick="toggleUserStatus(${u.id}, ${!u.is_active})">
                                        ${u.is_active ? 'Disable' : 'Enable'}
                                    </button>
                                ` : '<span class="protected-user">Protected</span>'}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users');
            }
        }

        async function updateUserRole(userId, newRole) {
            if (!confirm(`Change role to ${newRole}?`)) {
                refreshUsers();
                return;
            }

            try {
                await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ role: newRole })
                });
                alert('Role updated');
                refreshUsers();
            } catch (error) {
                console.error('Error updating:', error);
                alert('Failed to update');
                refreshUsers();
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            const action = newStatus ? 'enable' : 'disable';
            if (!confirm(`${action} this user?`)) return;

            try {
                await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ is_active: newStatus })
                });
                alert(`User ${action}d`);
                refreshUsers();
            } catch (error) {
                console.error('Error updating:', error);
                alert('Failed to update');
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const prevMonthDays = startingDayOfWeek;
            
            const totalCells = Math.ceil((daysInMonth + startingDayOfWeek) / 7) * 7;
            const nextMonthDays = totalCells - daysInMonth - prevMonthDays;
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            const todayDate = today.getDate();
            
            let html = '<div class="calendar-grid">';
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = isCurrentMonth && day === todayDate;
                
                const dayTasks = currentTasks.filter(t => t.next_run.split('T')[0] === dateStr);
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                
                dayTasks.forEach(task => {
                    const isOverdue = task.status === 'overdue';
                    html += `<div class="calendar-task ${isOverdue ? 'overdue' : ''}" onclick="editTaskFromDashboard(${task.id})" title="${task.name} - ${task.location}">${task.name}</div>`;
                });
                
                html += '</div>';
            }
            
            for (let day = 1; day <= nextMonthDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            html += '</div>';
            
            document.getElementById('calendarView').innerHTML = html;
        }

        function showAddLocationModal() {
            const parentSelect = document.getElementById('modalFlocParent');
            parentSelect.innerHTML = '<option value="">Choose parent...</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            
            document.getElementById('modalFlocName').value = '';
            document.getElementById('modalFlocDesc').value = '';
            
            if (selectedFlocId) {
                document.querySelector('input[name="parentType"][value="child"]').checked = true;
                document.getElementById('parentSelectContainer').classList.add('show');
                document.getElementById('modalFlocParent').value = selectedFlocId;
            } else {
                document.querySelector('input[name="parentType"][value="none"]').checked = true;
                document.getElementById('parentSelectContainer').classList.remove('show');
            }
            
            document.getElementById('addLocationModal').classList.add('show');
        }

        function toggleParentSelect(show) {
            const container = document.getElementById('parentSelectContainer');
            if (show) {
                container.classList.add('show');
            } else {
                container.classList.remove('show');
            }
            
            if (!show) {
                document.getElementById('modalFlocParent').value = '';
            }
        }

        function closeAddLocationModal() {
            document.getElementById('addLocationModal').classList.remove('show');
            document.getElementById('modalFlocName').removeEventListener('input', updateLocationPreview);
            document.getElementById('modalFlocParent').removeEventListener('change', updateLocationPreview);
        }

        async function addLocationFromModal() {
            const name = document.getElementById('modalFlocName').value.trim();
            const desc = document.getElementById('modalFlocDesc').value || null;
            const isChild = document.querySelector('input[name="parentType"][value="child"]').checked;
            const parentId = isChild ? document.getElementById('modalFlocParent').value : null;

            if (!name) {
                alert('Name required');
                return;
            }
            
            if (isChild && !parentId) {
                alert('Select parent');
                return;
            }

            try {
                await fetch(`${API_BASE}/funclocations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name,
                        description: desc,
                        parent_id: parentId ? parseInt(parentId) : null
                    })
                });

                closeAddLocationModal();
                await loadDashboard();
                alert('Location created!');
            } catch (error) {
                console.error('Error adding:', error);
                alert('Failed to add');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadDashboard();
                
                setInterval(() => {
                    checkAuth();
                    if (notificationPanelOpen) {
                        loadNotifications();
                    }
                }, 300000);
            }
        });

        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationPanel');
            const bell = document.querySelector('.notification-bell');
            if (notificationPanelOpen && !panel.contains(e.target) && !bell.contains(e.target)) {
                toggleNotifications();
            }
        });
    </script>
</body>
</html>