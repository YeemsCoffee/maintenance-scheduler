<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Scheduler</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>üîß Maintenance Scheduler</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #6b7280; font-size: 14px;">
                        üë§ <span id="currentUser"></span> (<span id="currentRole"></span>)
                    </span>
                    <button class="btn btn-secondary btn-small" onclick="showPage('calendar')">üìÖ Calendar</button>
                    <button class="btn btn-secondary btn-small" onclick="showPage('users')" id="manageUsersBtn" style="display: none;">Manage Users</button>
                    <button class="btn btn-secondary btn-small" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="grid">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üèóÔ∏è Functional Location Structure</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddLocationModal()">+ Add Location</button>
                    </div>
                    <div class="tree" id="flocTreeNav">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Location Details & Tasks</h2>
                    <div id="flocTaskView">
                        <div class="empty-state">Select a functional location from the tree</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendar" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìÖ Maintenance Calendar</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-secondary btn-small" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <span id="calendarMonth" style="font-weight: 600; min-width: 150px; text-align: center;"></span>
                        <button class="btn btn-secondary btn-small" onclick="changeMonth(1)">Next ‚Üí</button>
                        <button class="btn btn-secondary btn-small" onclick="showPage('dashboard')">‚Üê Back</button>
                    </div>
                </div>
                <div id="calendarView"></div>
            </div>
        </div>

        <!-- Tasks Management Page -->
        <div id="tasks" class="page">
            <div class="card">
                <h2>‚úèÔ∏è Edit Task</h2>
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="taskName" placeholder="e.g., Oil change">
                </div>
                <div class="form-group">
                    <label>Frequency (days)</label>
                    <input type="number" id="taskFreq" placeholder="90">
                </div>
                <div class="form-group">
                    <label>Next Run Date</label>
                    <input type="date" id="taskDate">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <select id="taskLocation">
                        <option value="">Select location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Functional Location</label>
                    <select id="taskFuncLoc">
                        <option value="">Select functional location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Part Name</label>
                    <input type="text" id="taskPart" placeholder="Optional">
                </div>
                <div class="two-col-grid">
                    <div class="form-group">
                        <label>Lead Time (days)</label>
                        <input type="number" id="taskLead" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" id="taskVendor" placeholder="Optional">
                    </div>
                </div>
                <div class="form-group">
                    <label>Vendor Part Number</label>
                    <input type="text" id="taskVendorPN" placeholder="Optional">
                </div>
                
                <div class="form-group">
                    <label>üìé Attachments (SOPs, Job Aids, etc.)</label>
                    <div id="attachmentsList" style="margin-bottom: 10px;">
                        <!-- Attachments will be listed here -->
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.xlsx,.xls" style="flex: 1;">
                        <button class="btn btn-secondary btn-small" onclick="uploadFile()">Upload</button>
                    </div>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 5px;">Allowed: PDF, Word, Excel, Images, Text files (Max 16MB)</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="updateTaskBtn" onclick="updateTask()">Save Changes</button>
                    <button class="btn btn-danger" id="deleteTaskBtn" onclick="deleteTask()">Delete Task</button>
                    <button class="btn btn-secondary" onclick="showPage('dashboard')">‚Üê Back to Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Functional Locations Management Page -->
        <div id="funcloc" class="page">
            <div class="grid">
                <div class="card">
                    <h2>üèóÔ∏è Functional Location Structure</h2>
                    <div class="tree" id="flocTree">
                        <div class="empty-state">Loading...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="refreshFlocs()">Refresh</button>
                        <button class="btn btn-secondary" onclick="showPage('dashboard')" style="margin-left: auto;">‚Üê Back to Dashboard</button>
                    </div>
                </div>

                <div>
                    <div class="card" style="margin-bottom: 20px;">
                        <h2>‚úèÔ∏è Edit Selected</h2>
                        <div id="flocEditSection">
                            <p style="color: #9ca3af; text-align: center; padding: 20px;">Select a functional location from the tree</p>
                        </div>
                    </div>

                    <div class="card">
                        <h2>‚ûï Add New Location</h2>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="newFlocName" placeholder="e.g., Building A">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="newFlocDesc" placeholder="Optional description"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Parent Location (optional)</label>
                            <select id="newFlocParent">
                                <option value="">(None)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addFloc()">Add Location</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Page (Admin Only) -->
        <div id="users" class="page">
            <div class="card">
                <h2>üë• User Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="empty-state">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="refreshUsers()">Refresh</button>
                    <button class="btn btn-secondary" onclick="showPage('dashboard')" style="margin-left: auto;">‚Üê Back to Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Add Location Modal -->
        <div id="addLocationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
            <div style="background: white; border-radius: 16px; padding: 0; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; color: white;">
                    <h2 style="margin: 0; font-size: 24px;">‚ûï Create Functional Location</h2>
                    <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Add a new location to organize your maintenance tasks</p>
                </div>
                
                <div style="padding: 30px;">
                    <div class="form-group">
                        <label style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; font-weight: 600;">Location Name *</label>
                        <input type="text" id="modalFlocName" placeholder="e.g., Building A, Floor 2, Production Line 1" style="font-size: 16px; padding: 14px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; font-weight: 600;">Description</label>
                        <textarea id="modalFlocDesc" placeholder="Optional: Add details about this location..." style="min-height: 80px; font-size: 14px;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; font-weight: 600;">Parent Location</label>
                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb; transition: all 0.2s;">
                                <input type="radio" name="parentType" value="none" checked onclick="toggleParentSelect(false)" style="cursor: pointer;">
                                <div>
                                    <div style="font-weight: 600; color: #374151; font-size: 14px;">üè† Top Level Location</div>
                                    <div style="font-size: 12px; color: #6b7280;">This will be a root location (no parent)</div>
                                </div>
                            </label>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb; transition: all 0.2s;">
                                <input type="radio" name="parentType" value="child" onclick="toggleParentSelect(true)" style="cursor: pointer;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #374151; font-size: 14px;">üìÅ Sub-Location</div>
                                    <div style="font-size: 12px; color: #6b7280;">Place this under an existing location</div>
                                </div>
                            </label>
                        </div>
                        <div id="parentSelectContainer" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 8px;">
                            <label style="font-size: 13px; color: #0369a1; font-weight: 600; margin-bottom: 8px; display: block;">Select Parent:</label>
                            <select id="modalFlocParent" style="width: 100%; padding: 12px; border: 2px solid #bae6fd; border-radius: 6px; font-size: 14px;">
                                <option value="">Choose a parent location...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="locationPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px;">
                        <div style="font-size: 12px; color: #15803d; font-weight: 600; margin-bottom: 8px;">üìç LOCATION PREVIEW:</div>
                        <div id="previewPath" style="font-size: 14px; color: #166534; font-weight: 500;"></div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 30px; gap: 12px;">
                        <button class="btn btn-primary" onclick="addLocationFromModal()" style="flex: 1; padding: 14px; font-size: 15px;">‚úì Create Location</button>
                        <button class="btn btn-secondary" onclick="closeAddLocationModal()" style="padding: 14px;">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin; // Uses current domain instead of localhost
        let currentTasks = [];
        let currentFlocs = [];
        let currentLocations = [];
        let selectedTaskId = null;
        let selectedFlocId = null;
        let expandedTreeNodes = new Set();
        let currentAttachments = [];
        let currentUserData = null;
        let currentCalendarDate = new Date();

        // Check authentication on load
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = `${API_BASE}/login.html`;
                    return false;
                }
                currentUserData = await response.json();
                document.getElementById('currentUser').textContent = currentUserData.username;
                document.getElementById('currentRole').textContent = currentUserData.role;
                
                // Show "Manage Users" button only for admins
                if (currentUserData.role === 'admin') {
                    document.getElementById('manageUsersBtn').style.display = 'block';
                }
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = `${API_BASE}/login.html`;
                return false;
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = `${API_BASE}/login.html`;
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = `${API_BASE}/login.html`;
            }
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'funcloc') {
                refreshFlocs();
            } else if (pageId === 'dashboard') {
                loadDashboard();
            } else if (pageId === 'users') {
                refreshUsers();
            } else if (pageId === 'calendar') {
                renderCalendar();
            }
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const [tasks, locations, flocs] = await Promise.all([
                    fetch(`${API_BASE}/tasks`).then(r => r.json()),
                    fetch(`${API_BASE}/locations`).then(r => r.json()),
                    fetch(`${API_BASE}/funclocations`).then(r => r.json())
                ]);

                currentTasks = tasks;
                currentFlocs = flocs;
                currentLocations = locations;

                buildFlocTreeNav();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('flocTreeNav').innerHTML = '<div class="empty-state">Failed to load data</div>';
            }
        }

        function buildFlocTreeNav() {
            const treeDiv = document.getElementById('flocTreeNav');
            
            if (currentFlocs.length === 0) {
                treeDiv.innerHTML = '<div class="empty-state">No functional locations yet.</div>';
                return;
            }

            // Build hierarchy
            const byId = {};
            currentFlocs.forEach(f => byId[f.id] = { ...f, children: [] });

            const roots = [];
            Object.values(byId).forEach(f => {
                if (f.parent_id && byId[f.parent_id]) {
                    byId[f.parent_id].children.push(f);
                } else {
                    roots.push(f);
                }
            });

            // Get all descendant tasks count recursively
            function getDescendantTaskCount(flocId) {
                let count = currentTasks.filter(t => t.func_loc_id === flocId).length;
                const children = currentFlocs.filter(f => f.parent_id === flocId);
                children.forEach(child => {
                    count += getDescendantTaskCount(child.id);
                });
                return count;
            }

            function renderNode(node, level = 0) {
                const indent = level > 0 ? 'tree-node-child' : '';
                const totalTasks = getDescendantTaskCount(node.id);
                const hasChildren = node.children.length > 0;
                const isExpanded = expandedTreeNodes.has(node.id);
                
                let html = `
                    <div class="${indent} tree-node" data-id="${node.id}">
                        ${hasChildren ? `<span onclick="toggleTreeNode(${node.id}); event.stopPropagation();" style="cursor: pointer; margin-right: 5px; display: inline-block; width: 12px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : '<span style="margin-right: 17px;"></span>'}
                        <span onclick="selectFlocFromTree(${node.id})">${node.name} <span style="color: #9ca3af; font-size: 12px;">(${totalTasks})</span></span>
                    </div>`;
                
                if (hasChildren && isExpanded) {
                    node.children.sort((a, b) => a.name.localeCompare(b.name)).forEach(child => {
                        html += renderNode(child, level + 1);
                    });
                }
                return html;
            }

            treeDiv.innerHTML = roots.sort((a, b) => a.name.localeCompare(b.name))
                .map(r => renderNode(r)).join('');
        }

        function toggleTreeNode(flocId) {
            if (expandedTreeNodes.has(flocId)) {
                expandedTreeNodes.delete(flocId);
            } else {
                expandedTreeNodes.add(flocId);
            }
            buildFlocTreeNav();
        }

        function selectFlocFromTree(id) {
            document.querySelectorAll('#flocTreeNav .tree-node').forEach(n => {
                const nodeId = n.getAttribute('data-id');
                if (nodeId == id) {
                    n.classList.add('selected');
                } else {
                    n.classList.remove('selected');
                }
            });

            const floc = currentFlocs.find(f => f.id === id);
            if (!floc) return;

            buildFlocDetailView(floc);
        }

        function buildFlocDetailView(floc) {
            const viewDiv = document.getElementById('flocTaskView');
            
            // Get all children recursively
            function getAllChildren(flocId) {
                const children = [];
                currentFlocs.forEach(f => {
                    if (f.parent_id === flocId) {
                        children.push(f);
                        children.push(...getAllChildren(f.id));
                    }
                });
                return children;
            }
            
            const children = getAllChildren(floc.id);
            
            // Get all descendant IDs (including the current floc)
            const descendantIds = [floc.id, ...children.map(c => c.id)];
            
            // Get tasks for this location AND all its descendants
            const allTasks = currentTasks.filter(t => descendantIds.includes(t.func_loc_id));
            const directTasks = currentTasks.filter(t => t.func_loc_id === floc.id);
            const childTasks = allTasks.filter(t => t.func_loc_id !== floc.id);

            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 22px; color: #1f2937; margin-bottom: 8px;">${floc.name}</h3>
                    ${floc.description ? `<p style="color: #6b7280; margin-bottom: 15px;">${floc.description}</p>` : ''}
                    ${floc.parent_id ? `<p style="color: #9ca3af; font-size: 13px;">Parent: ${currentFlocs.find(f => f.id === floc.parent_id)?.name || 'Unknown'}</p>` : ''}
                    <p style="color: #667eea; font-size: 14px; font-weight: 600; margin-top: 10px;">
                        Total Tasks: ${allTasks.length} ${allTasks.length !== directTasks.length ? `(${directTasks.length} direct, ${childTasks.length} from children)` : ''}
                    </p>
                </div>
            `;

            if (children.length > 0) {
                html += `
                    <div style="margin-bottom: 25px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <h4 style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">CHILD LOCATIONS (${children.length})</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${children.map(c => {
                                const childTaskCount = currentTasks.filter(t => t.func_loc_id === c.id).length;
                                return `
                                    <span onclick="selectFlocFromTree(${c.id})" style="cursor: pointer; padding: 6px 12px; background: white; border-radius: 6px; font-size: 13px; border: 1px solid #e5e7eb; transition: all 0.2s;"
                                    onmouseover="this.style.background='#ddd6fe'; this.style.borderColor='#c4b5fd';"
                                    onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
                                        ${c.name} <span style="color: #9ca3af;">(${childTaskCount})</span>
                                    </span>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (directTasks.length > 0) {
                html += `
                    <h4 style="font-size: 16px; color: #374151; margin-bottom: 15px;">Direct Tasks (${directTasks.length})</h4>
                    <div class="task-list">
                        ${directTasks.map(t => `
                            <div class="task-item" onclick="editTaskFromDashboard(${t.id})">
                                <div class="task-item-left">
                                    <div class="task-name">${t.name}</div>
                                    <div class="task-details">
                                        üìç ${t.location}
                                        ${t.part_name ? ` | üîß ${t.part_name}` : ''}
                                        ${t.vendor ? ` | üè™ ${t.vendor}` : ''}
                                        ${t.attachments && t.attachments.length > 0 ? ` | üìé ${t.attachments.length} file${t.attachments.length > 1 ? 's' : ''}` : ''}
                                    </div>
                                </div>
                                <div class="task-item-right">
                                    <div class="task-date">${t.next_run.split('T')[0]}</div>
                                    <div class="task-freq">Every ${t.frequency_days} days</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (childTasks.length > 0) {
                // Group child tasks by their functional location
                const tasksByFloc = {};
                childTasks.forEach(t => {
                    if (!tasksByFloc[t.func_loc_id]) {
                        tasksByFloc[t.func_loc_id] = [];
                    }
                    tasksByFloc[t.func_loc_id].push(t);
                });

                html += `
                    <h4 style="font-size: 16px; color: #374151; margin-top: 25px; margin-bottom: 15px;">Tasks from Child Locations (${childTasks.length})</h4>
                `;

                Object.keys(tasksByFloc).forEach(flocId => {
                    const childFloc = currentFlocs.find(f => f.id === parseInt(flocId));
                    const tasks = tasksByFloc[flocId];
                    
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h5 style="font-size: 14px; color: #6b7280; margin-bottom: 10px; padding-left: 10px; border-left: 3px solid #667eea;">
                                ${childFloc ? childFloc.name : 'Unknown Location'}
                            </h5>
                            <div class="task-list">
                                ${tasks.map(t => `
                                    <div class="task-item" onclick="editTaskFromDashboard(${t.id})" style="border-left-color: #a78bfa;">
                                        <div class="task-item-left">
                                            <div class="task-name">${t.name}</div>
                                            <div class="task-details">
                                                üìç ${t.location}
                                                ${t.part_name ? ` | üîß ${t.part_name}` : ''}
                                                ${t.vendor ? ` | üè™ ${t.vendor}` : ''}
                                                ${t.attachments && t.attachments.length > 0 ? ` | üìé ${t.attachments.length} file${t.attachments.length > 1 ? 's' : ''}` : ''}
                                            </div>
                                        </div>
                                        <div class="task-item-right">
                                            <div class="task-date">${t.next_run.split('T')[0]}</div>
                                            <div class="task-freq">Every ${t.frequency_days} days</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            if (allTasks.length === 0) {
                html += '<div class="no-tasks">No tasks assigned to this location or its children</div>';
            }

            viewDiv.innerHTML = html;
        }

        function editTaskFromDashboard(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            selectedTaskId = task.id;
            currentAttachments = task.attachments || [];

            // Populate form
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskFreq').value = task.frequency_days;
            document.getElementById('taskDate').value = task.next_run.split('T')[0];
            
            // Update dropdowns
            const locSelect = document.getElementById('taskLocation');
            locSelect.innerHTML = '<option value="">Select location...</option>' +
                currentLocations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            
            const locOpt = Array.from(locSelect.options).find(opt => opt.text === task.location);
            if (locOpt) locSelect.value = locOpt.value;

            const flocSelect = document.getElementById('taskFuncLoc');
            flocSelect.innerHTML = '<option value="">Select functional location...</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            
            if (task.func_loc_id) {
                flocSelect.value = task.func_loc_id;
            }

            document.getElementById('taskPart').value = task.part_name || '';
            document.getElementById('taskLead').value = task.lead_time_days || '';
            document.getElementById('taskVendor').value = task.vendor || '';
            document.getElementById('taskVendorPN').value = task.vendor_part_number || '';

            // Display attachments
            displayAttachments();

            // Show tasks page
            showPage('tasks');
        }

        function displayAttachments() {
            const listDiv = document.getElementById('attachmentsList');
            
            if (currentAttachments.length === 0) {
                listDiv.innerHTML = '<p style="color: #9ca3af; font-size: 13px; font-style: italic;">No attachments yet</p>';
                return;
            }

            const getFileIcon = (fileType) => {
                if (['pdf'].includes(fileType)) return 'üìÑ';
                if (['doc', 'docx'].includes(fileType)) return 'üìù';
                if (['xls', 'xlsx'].includes(fileType)) return 'üìä';
                if (['png', 'jpg', 'jpeg', 'gif'].includes(fileType)) return 'üñºÔ∏è';
                return 'üìé';
            };

            listDiv.innerHTML = currentAttachments.map(att => `
                <div class="attachment-item">
                    <div class="attachment-name">
                        <span class="attachment-icon">${getFileIcon(att.file_type)}</span>
                        <span>${att.original_filename}</span>
                    </div>
                    <div class="attachment-actions">
                        <button class="btn btn-icon" onclick="downloadAttachment(${att.id})">‚¨á Download</button>
                        <button class="btn btn-icon" onclick="deleteAttachment(${att.id})" style="color: #ef4444; border-color: #fecaca;">üóë Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            if (!selectedTaskId) {
                alert('No task selected');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/tasks/${selectedTaskId}/attachments`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const attachment = await response.json();
                currentAttachments.push(attachment);
                displayAttachments();
                fileInput.value = '';
                alert('File uploaded successfully!');
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Failed to upload file');
            }
        }

        async function downloadAttachment(attachmentId) {
            window.open(`${API_BASE}/attachments/${attachmentId}/download`, '_blank');
        }

        async function deleteAttachment(attachmentId) {
            if (!confirm('Delete this attachment?')) return;

            try {
                await fetch(`${API_BASE}/attachments/${attachmentId}`, { method: 'DELETE' });
                currentAttachments = currentAttachments.filter(a => a.id !== attachmentId);
                displayAttachments();
                alert('Attachment deleted');
            } catch (error) {
                console.error('Error deleting attachment:', error);
                alert('Failed to delete attachment');
            }
        }

        async function updateTask() {
            if (!selectedTaskId) return;

            const name = document.getElementById('taskName').value.trim();
            const freq = parseInt(document.getElementById('taskFreq').value);
            const date = document.getElementById('taskDate').value;
            const locId = document.getElementById('taskLocation').value;
            const flocId = document.getElementById('taskFuncLoc').value || null;

            if (!name || !freq || !date || !locId) {
                alert('Please fill in name, frequency, date, and location');
                return;
            }

            try {
                await fetch(`${API_BASE}/tasks/${selectedTaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        frequency_days: freq,
                        next_run: date,
                        location_id: parseInt(locId),
                        func_loc_id: flocId ? parseInt(flocId) : null,
                        part_name: document.getElementById('taskPart').value || '',
                        vendor: document.getElementById('taskVendor').value || '',
                        vendor_part_number: document.getElementById('taskVendorPN').value || '',
                        lead_time_days: parseInt(document.getElementById('taskLead').value) || 0
                    })
                });

                await loadDashboard();
                alert('Task updated successfully!');
                showPage('dashboard');
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task');
            }
        }

        async function deleteTask() {
            if (!selectedTaskId || !confirm('Delete this task?')) return;

            try {
                await fetch(`${API_BASE}/tasks/${selectedTaskId}`, { method: 'DELETE' });
                await loadDashboard();
                alert('Task deleted successfully!');
                showPage('dashboard');
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task');
            }
        }

        // Functional Locations Functions
        async function refreshFlocs() {
            try {
                const flocs = await fetch(`${API_BASE}/funclocations`).then(r => r.json());
                currentFlocs = flocs;

                buildFlocTree(flocs);
                updateFlocDropdowns();
            } catch (error) {
                console.error('Error refreshing functional locations:', error);
            }
        }

        function buildFlocTree(flocs) {
            const byId = {};
            flocs.forEach(f => byId[f.id] = { ...f, children: [] });

            const roots = [];
            Object.values(byId).forEach(f => {
                if (f.parent_id && byId[f.parent_id]) {
                    byId[f.parent_id].children.push(f);
                } else {
                    roots.push(f);
                }
            });

            const treeDiv = document.getElementById('flocTree');
            if (roots.length === 0) {
                treeDiv.innerHTML = '<div class="empty-state">No functional locations yet. Add one below!</div>';
                return;
            }

            function renderNode(node, level = 0) {
                const indent = level > 0 ? 'tree-node-child' : '';
                let html = `<div class="${indent} tree-node" onclick="selectFloc(${node.id})" data-id="${node.id}">${node.name}</div>`;
                node.children.sort((a, b) => a.name.localeCompare(b.name)).forEach(child => {
                    html += renderNode(child, level + 1);
                });
                return html;
            }

            treeDiv.innerHTML = roots.sort((a, b) => a.name.localeCompare(b.name))
                .map(r => renderNode(r)).join('');
        }

        function selectFloc(id) {
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            document.querySelector(`.tree-node[data-id="${id}"]`).classList.add('selected');

            selectedFlocId = id;
            const floc = currentFlocs.find(f => f.id === id);
            if (!floc) return;

            document.getElementById('flocEditSection').innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editFlocName" value="${floc.name}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editFlocDesc">${floc.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Parent Location</label>
                    <select id="editFlocParent">
                        <option value="">(None)</option>
                        ${currentFlocs.filter(f => f.id !== id).map(f => 
                            `<option value="${f.id}" ${f.id === floc.parent_id ? 'selected' : ''}>${f.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveFloc()">Save Changes</button>
                    <button class="btn btn-danger" onclick="deleteFloc()">Delete</button>
                </div>
            `;
        }

        function updateFlocDropdowns() {
            const parentSelect = document.getElementById('newFlocParent');
            parentSelect.innerHTML = '<option value="">(None)</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        }

        async function saveFloc() {
            if (!selectedFlocId) return;

            const name = document.getElementById('editFlocName').value.trim();
            const desc = document.getElementById('editFlocDesc').value || null;
            const parentId = document.getElementById('editFlocParent').value || null;

            if (!name) {
                alert('Name cannot be empty');
                return;
            }

            try {
                await fetch(`${API_BASE}/funclocations/${selectedFlocId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description: desc,
                        parent_id: parentId ? parseInt(parentId) : null
                    })
                });

                await refreshFlocs();
                await loadDashboard();
                alert('Saved successfully!');
            } catch (error) {
                console.error('Error saving functional location:', error);
                alert('Failed to save: ' + error.message);
            }
        }

        async function deleteFloc() {
            if (!selectedFlocId || !confirm('Delete this functional location? You must first reparent/delete any children and move/delete any tasks.')) return;

            try {
                const response = await fetch(`${API_BASE}/funclocations/${selectedFlocId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const data = await response.json();
                    alert('Failed to delete: ' + data.message);
                    return;
                }

                selectedFlocId = null;
                await refreshFlocs();
                await loadDashboard();
                document.getElementById('flocEditSection').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Select a functional location from the tree</p>';
            } catch (error) {
                console.error('Error deleting functional location:', error);
                alert('Failed to delete');
            }
        }

        async function addFloc() {
            const name = document.getElementById('newFlocName').value.trim();
            const desc = document.getElementById('newFlocDesc').value || null;
            const parentId = document.getElementById('newFlocParent').value || null;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            try {
                await fetch(`${API_BASE}/funclocations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description: desc,
                        parent_id: parentId ? parseInt(parentId) : null
                    })
                });

                document.getElementById('newFlocName').value = '';
                document.getElementById('newFlocDesc').value = '';
                document.getElementById('newFlocParent').value = '';
                await refreshFlocs();
                await loadDashboard();
            } catch (error) {
                console.error('Error adding functional location:', error);
                alert('Failed to add functional location');
            }
        }

        // User Management Functions
        async function refreshUsers() {
            if (currentUserData.role !== 'admin') {
                alert('Admin access required');
                showPage('dashboard');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/users`, {
                    credentials: 'include'
                });
                const users = await response.json();

                const tbody = document.getElementById('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
                } else {
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            <td><strong>${u.username}</strong></td>
                            <td>${u.email}</td>
                            <td>
                                <select onchange="updateUserRole(${u.id}, this.value)" ${u.username === 'admin' ? 'disabled' : ''}>
                                    <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="technician" ${u.role === 'technician' ? 'selected' : ''}>Technician</option>
                                    <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                </select>
                            </td>
                            <td>
                                <span style="color: ${u.is_active ? '#10b981' : '#ef4444'};">
                                    ${u.is_active ? '‚úì Active' : '‚úó Disabled'}
                                </span>
                            </td>
                            <td>${new Date(u.created_at).toLocaleDateString()}</td>
                            <td>
                                ${u.username !== 'admin' ? `
                                    <button class="btn btn-secondary btn-small" onclick="toggleUserStatus(${u.id}, ${!u.is_active})">
                                        ${u.is_active ? 'Disable' : 'Enable'}
                                    </button>
                                ` : '<span style="color: #9ca3af;">Protected</span>'}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users');
            }
        }

        async function updateUserRole(userId, newRole) {
            if (!confirm(`Change this user's role to ${newRole}?`)) {
                refreshUsers(); // Reset dropdown
                return;
            }

            try {
                await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ role: newRole })
                });
                alert('User role updated');
                refreshUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Failed to update user role');
                refreshUsers();
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            const action = newStatus ? 'enable' : 'disable';
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }

            try {
                await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ is_active: newStatus })
                });
                alert(`User ${action}d successfully`);
                refreshUsers();
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Failed to update user status');
            }
        }

        // Calendar Functions
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const prevMonthDays = startingDayOfWeek;
            
            // Calculate total cells needed
            const totalCells = Math.ceil((daysInMonth + startingDayOfWeek) / 7) * 7;
            const nextMonthDays = totalCells - daysInMonth - prevMonthDays;
            
            // Today
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            const todayDate = today.getDate();
            
            let html = '<div class="calendar-grid">';
            
            // Headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Previous month days
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = isCurrentMonth && day === todayDate;
                
                // Get tasks for this day
                const dayTasks = currentTasks.filter(t => t.next_run.split('T')[0] === dateStr);
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                
                // Add tasks
                dayTasks.forEach(task => {
                    const taskDate = new Date(task.next_run);
                    const isOverdue = taskDate < today && dateStr !== today.toISOString().split('T')[0];
                    html += `<div class="calendar-task ${isOverdue ? 'overdue' : ''}" onclick="editTaskFromCalendar(${task.id})" title="${task.name} - ${task.location}">${task.name}</div>`;
                });
                
                html += '</div>';
            }
            
            // Next month days
            for (let day = 1; day <= nextMonthDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            html += '</div>';
            
            document.getElementById('calendarView').innerHTML = html;
        }

        function editTaskFromCalendar(taskId) {
            editTaskFromDashboard(taskId);
        }

        // Add Location Modal Functions
        function showAddLocationModal() {
            // Populate parent dropdown
            const parentSelect = document.getElementById('modalFlocParent');
            parentSelect.innerHTML = '<option value="">Choose a parent location...</option>' +
                currentFlocs.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            
            // Clear form
            document.getElementById('modalFlocName').value = '';
            document.getElementById('modalFlocDesc').value = '';
            document.querySelector('input[name="parentType"][value="none"]').checked = true;
            document.getElementById('parentSelectContainer').style.display = 'none';
            document.getElementById('locationPreview').style.display = 'none';
            
            // Add event listeners for live preview
            document.getElementById('modalFlocName').addEventListener('input', updateLocationPreview);
            document.getElementById('modalFlocParent').addEventListener('change', updateLocationPreview);
            
            // Show modal
            document.getElementById('addLocationModal').style.display = 'flex';
        }

        function toggleParentSelect(show) {
            document.getElementById('parentSelectContainer').style.display = show ? 'block' : 'none';
            updateLocationPreview();
        }

        function updateLocationPreview() {
            const name = document.getElementById('modalFlocName').value.trim();
            const isChild = document.querySelector('input[name="parentType"][value="child"]').checked;
            const parentId = document.getElementById('modalFlocParent').value;
            
            if (!name) {
                document.getElementById('locationPreview').style.display = 'none';
                return;
            }
            
            let path = '';
            if (isChild && parentId) {
                const parent = currentFlocs.find(f => f.id == parentId);
                if (parent) {
                    // Build full path
                    const getFullPath = (loc) => {
                        if (loc.parent_id) {
                            const p = currentFlocs.find(f => f.id === loc.parent_id);
                            if (p) return getFullPath(p) + ' ‚Üí ' + loc.name;
                        }
                        return loc.name;
                    };
                    path = getFullPath(parent) + ' ‚Üí ' + name;
                }
            } else {
                path = name;
            }
            
            document.getElementById('previewPath').textContent = path;
            document.getElementById('locationPreview').style.display = 'block';
        }

        function closeAddLocationModal() {
            document.getElementById('addLocationModal').style.display = 'none';
            document.getElementById('modalFlocName').removeEventListener('input', updateLocationPreview);
            document.getElementById('modalFlocParent').removeEventListener('change', updateLocationPreview);
        }

        async function addLocationFromModal() {
            const name = document.getElementById('modalFlocName').value.trim();
            const desc = document.getElementById('modalFlocDesc').value || null;
            const isChild = document.querySelector('input[name="parentType"][value="child"]').checked;
            const parentId = isChild ? document.getElementById('modalFlocParent').value : null;

            if (!name) {
                alert('Please enter a location name');
                return;
            }
            
            if (isChild && !parentId) {
                alert('Please select a parent location');
                return;
            }

            try {
                await fetch('/funclocations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name,
                        description: desc,
                        parent_id: parentId ? parseInt(parentId) : null
                    })
                });

                closeAddLocationModal();
                await loadDashboard();
                
                // Show success message
                const preview = document.getElementById('previewPath').textContent;
                alert(`‚úì Location created successfully!\n\n${preview}`);
            } catch (error) {
                console.error('Error adding functional location:', error);
                alert('Failed to add functional location. Please try again.');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadDashboard();
            }
        });
    </script>
</body>
</html>